{% extends "base.html" %}
{% block title %}User Management{% endblock %}

{% block content %}
<section id="content-users" class="page-section active">
    <div class="page-header">
        <div class="page-title">
            <h1>User Management</h1>
            <p>Manage user accounts and assign roles across the organization.</p>
        </div>
        <div class="page-actions">
            <button class="btn btn-primary" onclick="openAddUserModal()">
                <i class="fa-solid fa-user-plus"></i> Add User
            </button>
        </div>
    </div>

    <!-- Role Summary Cards -->
    <div class="grid grid-4 mb-4" id="role-summary-cards">
        <div class="card kpi-card">
            <div class="kpi-header">
                <div class="kpi-body">
                    <h4>Total Users</h4>
                    <div class="value" id="stat-total">—</div>
                </div>
                <div class="kpi-icon bg-info-light text-info"><i class="fa-solid fa-users"></i></div>
            </div>
        </div>
        <div class="card kpi-card">
            <div class="kpi-header">
                <div class="kpi-body">
                    <h4>Managers</h4>
                    <div class="value" id="stat-managers">—</div>
                </div>
                <div class="kpi-icon bg-success-light text-success"><i class="fa-solid fa-user-tie"></i></div>
            </div>
        </div>
        <div class="card kpi-card">
            <div class="kpi-header">
                <div class="kpi-body">
                    <h4>Dispatchers</h4>
                    <div class="value" id="stat-dispatchers">—</div>
                </div>
                <div class="kpi-icon bg-warning-light text-warning"><i class="fa-solid fa-headset"></i></div>
            </div>
        </div>
        <div class="card kpi-card">
            <div class="kpi-header">
                <div class="kpi-body">
                    <h4>Active</h4>
                    <div class="value" id="stat-active">—</div>
                </div>
                <div class="kpi-icon bg-danger-light text-danger"><i class="fa-solid fa-circle-check"></i></div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-header">
            <h3>All Users</h3>
            <button class="btn-ghost" onclick="loadUsers()" style="padding:0;">
                <i class="fa-solid fa-rotate-right"></i> Refresh
            </button>
        </div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Current Role</th>
                        <th>Assign Role</th>
                        <th>Status</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr>
                        <td colspan="6" style="text-align:center; padding:2rem; color:var(--text-muted);">
                            <i class="fa-solid fa-spinner fa-spin"></i> Loading users...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Add User Modal -->
<div class="modal-overlay" id="add-user-modal" style="display:none;">
    <div class="modal-card">
        <div class="modal-header">
            <h3><i class="fa-solid fa-user-plus"></i> Add New User</h3>
            <button class="btn-icon" onclick="closeAddUserModal()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <form onsubmit="addUser(event)">
            <div class="card-body">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" class="form-control" id="new-user-name" placeholder="John Smith" required>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" class="form-control" id="new-user-email" placeholder="john@fleetflow.com"
                        required>
                </div>
                <div class="form-group">
                    <label>Assign Role</label>
                    <select class="form-control" id="new-user-role" required>
                        <option value="manager">Manager</option>
                        <option value="dispatcher" selected>Dispatcher</option>
                        <option value="safety">Safety Officer</option>
                        <option value="finance">Financial Analyst</option>
                    </select>
                </div>
                <div id="add-user-error"
                    style="display:none; padding:0.75rem; border-radius:var(--radius-md); background:rgba(239,68,68,0.1); color:#EF4444; font-size:0.85rem;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeAddUserModal()">Cancel</button>
                <button type="submit" class="btn btn-primary"><i class="fa-solid fa-check"></i> Create User</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadUsers();
        setActiveNavLink('users');
    });
</script>
{% endblock %}